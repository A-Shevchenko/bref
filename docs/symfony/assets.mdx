import { Callout } from 'nextra/components';

export const introduction = 'Run Symfony serverless on AWS Lambda using Bref.';

# Symfony assets

To deploy Symfony websites, assets need to be served from AWS S3. The easiest approach is to use the [Server-side website construct of the Lift plugin](https://github.com/getlift/lift/blob/master/docs/server-side-website.md).

This will deploy a CloudFront distribution (CDN) that will act as a proxy: it will serve static files directly from S3 and will forward everything else to Lambda. This is very close to how traditional web servers like Apache or Nginx work, which means your application doesn't need to change! For more details, read [the official documentation](https://github.com/getlift/lift/blob/master/docs/server-side-website.md#how-it-works).

First install the plugin

```bash
serverless plugin install -n serverless-lift
```

Then add this configuration to your `serverless.yml` file.

```yml filename="serverless.yml" {10,12-20}
service: symfony
provider:
    # ...

functions:
    # ...

plugins:
    - ./vendor/bref/bref
    - serverless-lift

constructs:
    website:
        type: server-side-website
        assets:
            '/bundles/*': public/bundles
            '/build/*': public/build
            '/favicon.ico': public/favicon.ico
            '/robots.txt': public/robots.txt
            # add here any file or directory that needs to be served from S3
```

Because this construct sets the `X-Forwarded-Host` header by default, you should add it in your `trusted_headers` config, otherwise Symfony might generate wrong URLs.

```yml filename="config/packages/framework.yaml" /, 'x-forwarded-host'/
   trusted_headers: [ 'x-forwarded-for', 'x-forwarded-proto', 'x-forwarded-port', 'x-forwarded-host' ]
```

Before deploying, compile your assets:

```bash
php bin/console assets:install --env prod
# if using Webpack Encore, additionally run
yarn encore production
```

Now deploy your website using `serverless deploy`. Lift will create all required resources and take care of uploading your assets to S3 automatically.

TODO
For more details, see the [Websites section](../web-apps/website-assets.md) of this documentation and the official [Lift documentation](https://github.com/getlift/lift/blob/master/docs/server-side-website.md).

<Callout>
    If you are not using Flex, update `serverless.yml` to exclude assets from the deployment ([see the recipe](https://github.com/symfony/recipes-contrib/blob/master/bref/symfony-bridge/0.1/serverless.yaml#L35))
</Callout>

## Assets in templates

For the above configuration to work, assets must be referenced in Twig templates via the `asset()` helper as [recommended by Symfony](https://symfony.com/doc/current/templates.html#linking-to-css-javascript-and-image-assets):

```diff
- <img src="/images/logo.png">
+ <img src="{{ asset('images/logo.png') }}">
```
